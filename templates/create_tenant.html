{% extends "base.html" %}

{% block title %}Create New Tenant - SSE Tenant Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('list_tenants') }}">All Tenants</a></li>
                <li class="breadcrumb-item active">Create New Tenant</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="{{ url_for('list_tenants') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-plus"></i> Create New Tenant
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" id="createTenantForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-building"></i> Company Information</h5>
                            
                            <div class="mb-3">
                                <label for="name" class="form-label">Company Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="e.g., Acme Corporation" value="{{ defaults.name }}">
                                <div class="form-text">The official name of the organization</div>
                            </div>

                            <div class="mb-3">
                                <label for="seats" class="form-label">Number of Seats <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="seats" name="seats" min="1" required 
                                       value="{{ defaults.seats }}" placeholder="1">
                                <div class="form-text">Number of user seats for this tenant</div>
                            </div>

                            <div class="mb-3">
                                <label for="comments" class="form-label">Comments</label>
                                <textarea class="form-control" id="comments" name="comments" rows="2" 
                                          placeholder="Comments">{{ defaults.comments }}</textarea>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5><i class="fas fa-user-shield"></i> Primary Administrator</h5>
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="primaryAdminFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="primaryAdminFirstName" 
                                               name="primaryAdminFirstName" required 
                                               value="{{ defaults.primaryAdminFirstName }}" placeholder="First Name">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="primaryAdminLastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="primaryAdminLastName" 
                                               name="primaryAdminLastName" required 
                                               value="{{ defaults.primaryAdminLastName }}" placeholder="Last Name">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="primaryAdminEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="primaryAdminEmail" 
                                       name="primaryAdminEmail" required 
                                       value="{{ defaults.primaryAdminEmail }}" placeholder="admin@example.com">
                                <div class="form-text">Primary administrator's email address</div>
                            </div>

                            <div class="mb-3">
                                <label for="extraAdminEmails" class="form-label">Additional Admin Emails</label>
                                <input type="text" class="form-control" id="extraAdminEmails" 
                                       name="extraAdminEmails" 
                                       value="{{ defaults.extraAdminEmails }}" placeholder="admin2@example.com, admin3@example.com">
                                <div class="form-text">Comma-separated list of additional administrator emails</div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="fas fa-map-marker-alt"></i> Address Information</h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addressLine1" class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addressLine1" name="addressLine1" 
                                       required 
                                       value="{{ defaults.addressLine1 }}" placeholder="123 Main St">
                            </div>

                            <div class="mb-3">
                                <label for="addressLine2" class="form-label">Address Line 2</label>
                                <input type="text" class="form-control" id="addressLine2" name="addressLine2" 
                                       value="{{ defaults.addressLine2 }}" placeholder="Suite 100">
                            </div>

                            <div class="mb-3">
                                <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="city" name="city" required 
                                       value="{{ defaults.city }}" placeholder="City">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="state" class="form-label">State/Province <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="state" name="state" required 
                                       value="{{ defaults.state }}" placeholder="State">
                                <div class="form-text">State abbreviation (e.g., CA, NY, TX)</div>
                            </div>

                            <div class="mb-3">
                                <label for="zipCode" class="form-label">ZIP/Postal Code <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="zipCode" name="zipCode" required 
                                       value="{{ defaults.zipCode }}" placeholder="Zip Code">
                            </div>

                            <div class="mb-3">
                                <label for="countryCode" class="form-label">Country Code <span class="text-danger">*</span></label>
                                <select class="form-control" id="countryCode" name="countryCode" required 
                                        value="{{ defaults.countryCode }}">
                                    <option value="">Select Country</option>
                                    <option value="US" {% if defaults.countryCode == 'US' %}selected{% endif %}>United States (US)</option>
                                    <option value="CA" {% if defaults.countryCode == 'CA' %}selected{% endif %}>Canada (CA)</option>
                                    <option value="GB" {% if defaults.countryCode == 'GB' %}selected{% endif %}>United Kingdom (GB)</option>
                                    <option value="DE" {% if defaults.countryCode == 'DE' %}selected{% endif %}>Germany (DE)</option>
                                    <option value="FR" {% if defaults.countryCode == 'FR' %}selected{% endif %}>France (FR)</option>
                                    <option value="JP" {% if defaults.countryCode == 'JP' %}selected{% endif %}>Japan (JP)</option>
                                    <option value="AU" {% if defaults.countryCode == 'AU' %}selected{% endif %}>Australia (AU)</option>
                                    <option value="IN" {% if defaults.countryCode == 'IN' %}selected{% endif %}>India (IN)</option>
                                    <option value="BR" {% if defaults.countryCode == 'BR' %}selected{% endif %}>Brazil (BR)</option>
                                    <option value="MX" {% if defaults.countryCode == 'MX' %}selected{% endif %}>Mexico (MX)</option>
                                </select>
                                <div class="form-text">ISO 3166-1 alpha-2 country code</div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-undo"></i> Reset Form
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="previewTenant()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Create Tenant
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Guidelines
                </h5>
            </div>
            <div class="card-body">
                <h6>Required Fields</h6>
                <p class="small text-muted">
                    Fields marked with <span class="text-danger">*</span> are required to create a tenant.
                </p>

                <h6>Email Format</h6>
                <p class="small text-muted">
                    Use valid email addresses for administrators. Multiple additional emails 
                    should be separated by commas.
                </p>

                <h6>Country Codes</h6>
                <p class="small text-muted">
                    Use ISO 3166-1 alpha-2 country codes (e.g., US, CA, GB).
                </p>

                <h6>Seats</h6>
                <p class="small text-muted">
                    Number of user seats determines how many users can be assigned to this tenant.
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb"></i> Tips
                </h5>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Double-check email addresses before submitting</li>
                    <li>Use descriptive company names for easy identification</li>
                    <li>Keep comments brief but informative</li>
                    <li>Ensure address information is accurate for billing</li>
                    <li>Start with a conservative number of seats - can be adjusted later</li>
                </ul>
            </div>
        </div>

        <!-- Sample Data Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-magic"></i> Quick Fill
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Fill form with sample data for testing:</p>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillSampleData()">
                    <i class="fas fa-magic"></i> Fill Sample Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye"></i> Tenant Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded" id="previewData"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="submitForm()" data-bs-dismiss="modal">
                    <i class="fas fa-plus"></i> Create Tenant
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function resetForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('createTenantForm').reset();
    }
}

function fillSampleData() {
    // Fill form with sample data for testing
    document.getElementById('name').value = 'Sample Company Inc';
    document.getElementById('seats').value = '5';
    document.getElementById('comments').value = 'Sample tenant for testing purposes';
    document.getElementById('primaryAdminFirstName').value = 'John';
    document.getElementById('primaryAdminLastName').value = 'Doe';
    document.getElementById('primaryAdminEmail').value = 'admin@samplecompany.com';
    document.getElementById('extraAdminEmails').value = 'manager@samplecompany.com, it@samplecompany.com';
    document.getElementById('addressLine1').value = '123 Sample Street';
    document.getElementById('addressLine2').value = 'Suite 100';
    document.getElementById('city').value = 'San Francisco';
    document.getElementById('state').value = 'CA';
    document.getElementById('zipCode').value = '94102';
    document.getElementById('countryCode').value = 'US';
}

function previewTenant() {
    const formData = new FormData(document.getElementById('createTenantForm'));
    const tenantData = {};
    
    for (let [key, value] of formData.entries()) {
        if (key === 'seats') {
            tenantData[key] = parseInt(value);
        } else if (key === 'extraAdminEmails' && value.trim()) {
            tenantData[key] = value.split(',').map(email => email.trim()).filter(email => email);
        } else if (value.trim()) {
            tenantData[key] = value;
        }
    }
    
    document.getElementById('previewData').textContent = JSON.stringify(tenantData, null, 2);
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function submitForm() {
    document.getElementById('createTenantForm').submit();
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createTenantForm');
    
    form.addEventListener('submit', function(event) {
        const emailInput = document.getElementById('primaryAdminEmail');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!emailRegex.test(emailInput.value)) {
            event.preventDefault();
            alert('Please enter a valid email address for the primary administrator.');
            emailInput.focus();
            return false;
        }

        // Validate additional emails if provided
        const extraEmailsInput = document.getElementById('extraAdminEmails');
        if (extraEmailsInput.value.trim()) {
            const emails = extraEmailsInput.value.split(',').map(email => email.trim());
            for (let email of emails) {
                if (email && !emailRegex.test(email)) {
                    event.preventDefault();
                    alert(`Invalid email address: ${email}`);
                    extraEmailsInput.focus();
                    return false;
                }
            }
        }

        // Show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Tenant...';
        submitButton.disabled = true;
        
        // Re-enable button after a delay (in case form submission fails)
        setTimeout(() => {
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }, 30000);
    });

    // Real-time email validation
    const emailInput = document.getElementById('primaryAdminEmail');
    emailInput.addEventListener('blur', function() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (this.value && !emailRegex.test(this.value)) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
});
</script>
{% endblock %}
