# Apache Configuration for Tenant Manager App
# Deploy at /tenant-manager-app endpoint
#
# This configuration should be placed in:
# /etc/httpd/conf.d/tenant-manager-app.conf

# Load required modules (ensure these are enabled)
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule expires_module modules/mod_expires.so

# Define upstream backend
ProxyPreserveHost On
ProxyRequests Off

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /opt/tenant-manager-app
    
    # Logging
    CustomLog /var/log/httpd/tenant-manager-app_access.log combined
    ErrorLog /var/log/httpd/tenant-manager-app_error.log
    LogLevel warn
    
    # Security headers
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server signature for security
    ServerTokens Prod
    ServerSignature Off
    
    # Main application proxy
    ProxyPass /tenant-manager-app/ http://127.0.0.1:5000/
    ProxyPassReverse /tenant-manager-app/ http://127.0.0.1:5000/
    
    # Preserve headers for proper routing
    ProxyPreserveHost On
    ProxyPassReverse /tenant-manager-app/ http://127.0.0.1:5000/
    
    # Set headers for backend
    <LocationMatch "^/tenant-manager-app/">
        ProxySet X-Forwarded-Proto %{REQUEST_SCHEME}
        ProxySet X-Forwarded-Host %{HTTP_HOST}
        ProxySet X-Forwarded-Port %{SERVER_PORT}
        ProxySet X-Real-IP %{REMOTE_ADDR}
    </LocationMatch>
    
    # Redirect root to application
    RewriteEngine On
    RewriteRule ^/?$ /tenant-manager-app/ [R=302,L]
    
    # Static files with caching
    Alias /tenant-manager-app/static /opt/tenant-manager-app/static
    <Directory "/opt/tenant-manager-app/static">
        Require all granted
        
        # Enable caching for static files
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        
        # Set cache headers
        Header set Cache-Control "public, immutable"
        Header append Vary Accept-Encoding
        
        # Compression
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|ico)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Directory>
    
    # Favicon handling
    Alias /favicon.ico /opt/tenant-manager-app/static/favicon.ico
    <LocationMatch "^/favicon\.ico$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </LocationMatch>
    
    # Health check endpoint
    <LocationMatch "^/tenant-manager-app/health">
        # Quick timeout for health checks
        ProxyTimeout 5
    </LocationMatch>
    
    # Security: Deny access to sensitive files
    <DirectoryMatch "/\.">
        Require all denied
    </DirectoryMatch>
    
    <FilesMatch "\.(env|log|conf|py|pyc)$">
        Require all denied
    </FilesMatch>
    
    # Protect application directory
    <Directory "/opt/tenant-manager-app">
        Require all denied
        
        # Allow only static directory
        <Directory "/opt/tenant-manager-app/static">
            Require all granted
        </Directory>
    </Directory>
    
    # Rate limiting (requires mod_evasive)
    # DOSHashTableSize    4096
    # DOSPageCount        3
    # DOSPageInterval     1
    # DOSSiteCount        50
    # DOSSiteInterval     1
    # DOSBlockingPeriod   600
    
    # Timeout settings
    Timeout 60
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100
    
    # Handle large uploads
    LimitRequestBody 10485760  # 10MB
</VirtualHost>

# SSL Configuration (uncomment and configure for HTTPS)
# <IfModule mod_ssl.c>
# <VirtualHost *:443>
#     ServerName localhost
#     DocumentRoot /opt/tenant-manager-app
#     
#     # SSL Configuration
#     SSLEngine on
#     SSLCertificateFile /etc/ssl/certs/tenant-manager-app.crt
#     SSLCertificateKeyFile /etc/ssl/private/tenant-manager-app.key
#     
#     # Modern SSL configuration
#     SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
#     SSLHonorCipherOrder off
#     SSLCompression off
#     SSLSessionTickets off
#     
#     # HSTS
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#     
#     # Same configuration as HTTP virtual host
#     # ... (copy all directives from HTTP VirtualHost above)
# </VirtualHost>
# </IfModule>

# Additional security configurations for main httpd.conf
# ServerTokens Prod
# ServerSignature Off
# 
# # Hide Apache version
# Header unset Server
# Header always unset X-Powered-By
# 
# # Prevent access to .htaccess files
# <Files ".ht*">
#     Require all denied
# </Files>
